function Xrkmonitor_config(){return{report_url:"http://xrkmonitor.com/cgi-bin/mt_slog_reportinfo",plugins_ary:["monitor_website",""],js_self_name:"dmt_xrkmonitor.js",json2_js_name:"dmt_json2_min.js",log_config_id:0,master_user_id:0,access_key:""}}function Xrkmonitor(e){var t=Xrkmonitor_config(),r=Xrkmonitor_obj();r.report_url=t.report_url,r.json2_js_name=t.json2_js_name,r.js_self_name=t.js_self_name,r.log_config_id=t.log_config_id,r.master_user_id=t.master_user_id,r.access_key=t.access_key,r.plugins_ary=t.plugins_ary;try{void 0!==window.top.self_xrk&&window.top.self_xrk?(window.self_xrk=window.top.self_xrk,window.self_xrk.load_more++,window.self_xrk.plugins_add_monitor()):(window.top.self_xrk=r,(window.self_xrk=r)._init_start(e))}catch(t){(window.self_xrk=r)._init_more(e),r.local_msg("(api) get exception:"+t.message)}}function Xrkmonitor_obj(){var xrk={report_attr_add:function(t,e){return this._inner_xrk_report_attr("add",t,e)},report_attr_set:function(t,e){return this._inner_xrk_report_attr("set",t,e)},report_strattr_add:function(t,e,r){return this._inner_xrk_report_strattr("add",t,e,r)},report_strattr_set:function(t,e,r){return this._inner_xrk_report_strattr("set",t,e,r)},init_log:function(t){void 0!==t&&0!=t?this.log_config_id=t:this.local_msg("xrkmonitor - init failed, invalid log_config_id")},cloud_init_report:function(t,e){void 0!==t&&(this.master_user_id=t),void 0!==e&&(this.access_key=e)},report_error_log:function(t,e){void 0!==e?this._report_log("error",e+t):this._report_log("error","[js:log:35]"+t)},report_warn_log:function(t,e){void 0!==e?this._report_log("warn",t):this._report_log("warn","[js:log:41]"+t)},report_reqerr_log:function(t,e){void 0!==e?this._report_log("reqerr",t):this._report_log("reqerr","[js:log:47]"+t)},report_info_log:function(t,e){void 0!==e?this._report_log("info",t):this._report_log("info","[js:log:53]"+t)},report_debug_log:function(t,e){void 0!==e?this._report_log("debug",t):this._report_log("debug","[js:log:59]"+t)},report_to_server:function(t){if(""!=this.report_url){if(void 0===t||t<=0){if(0==this.last_req_seq){if(0!=this.last_delay_timer_id){try{clearTimeout(this.last_delay_timer_id)}catch(t){this.local_msg("(api - report_to_server) get exception:"+t.message)}this.last_delay_timer_id=0}return this._report_to_server()}t=50}0==this.last_delay_timer_id&&(t<10?t=10:t>=this.try_timer_ms&&(t=this.try_timer_ms),this._report_to_server(t))}else this.local_msg("xrkmonitor - report failed, request url not set !")},reg_on_response:function(t){this.on_xrk_response=t},local_msg:function(t){var e;this.debug&&(e=(new Date).getTime()+" : xrkmonitor - "+t,"undefined"!=typeof console&&console.log(e))},_try_set_config:function(t){var e=this;"string"==typeof t.report_url&&0==e.set_report_url&&(e.report_url=t.report_url,e.set_report_url=1,e.local_msg("set new report url address:"+e.report_url)),"number"==typeof t.cloud_master_user&&"string"==typeof t.cloud_access_key&&0==e.master_user_id&&(e.master_user_id=t.cloud_master_user,e.access_key=t.cloud_access_key,e.local_msg("cloud init - user:"+e.master_user_id+", key:"+e.access_key))},load_script:function(t,e){try{var r=document.createElement("script");r.type="text/javascript",void 0!==r.readyState?r.onreadystatechange=function(){"loaded"!=r.readyState&&"complete"!=r.readyState&&"done"!=r.readyState||(r.onreadystatechange=null,"function"==typeof e&&e())}:r.onload=function(){"function"==typeof e&&e()},r.src=t,document.getElementsByTagName("head")[0].appendChild(r)}catch(t){this.local_msg("(api - load_script) get exception:"+t.message)}},_load_plugin:function(plugin_name){var plugin_js=plugin_name+".js",config_js=plugin_name+"_conf.js",xrk_self=this;this.load_script(this.api_js_url.replace(this.js_self_name,config_js),function(){var xrk_config=eval("xrk_config_"+plugin_name);"object"==typeof xrk_config&&xrk_config.plugin_name==plugin_name?(xrk_self.debug&&xrk_self.local_msg("load plugin:"+plugin_name+" config file:"+config_js+" ok"),xrk_self.load_script(xrk_self.api_js_url.replace(xrk_self.js_self_name,plugin_js),function(){var xrk_monitor=eval("xrk_monitor_"+plugin_name+"()"),o_plugin;"object"==typeof xrk_monitor&&xrk_monitor.plugin_name==plugin_name?(xrk_self.debug&&xrk_self.local_msg("load plugin:"+plugin_name+" ok"),xrk_self._try_set_config(xrk_config),o_plugin=new Object,o_plugin.create=eval("xrk_monitor_"+plugin_name),o_plugin.config=xrk_config,o_plugin.monitor_win_list=new Array,o_plugin.logs=new Array,o_plugin.cur_logs_strlen=0,xrk_monitor.monitor_window(o_plugin,window),o_plugin.monitor_win_list.push(xrk_monitor),xrk_self.plugins.push(o_plugin),xrk_self.debug&&xrk_self.local_msg("plugin count:"+xrk_self.plugins.length)):xrk_self.debug&&xrk_self.local_msg("load plugin:"+plugin_name+" js failed !")})):this.debug&&this.local_msg("load plugin:"+plugin_name+" config:"+plugin_js+" failed !")})},is_xrkmonitor_js:function(t){var e=this;if(-1!=t.indexOf(e.json2_js_name)||-1!=t.indexOf(e.js_self_name))return!0;for(var r=0;r<e.plugins.length;r++)if(-1!=t.indexOf(e.plugins[r].config.plugin_name+".js")||-1!=t.indexOf(e.plugins[r].config.plugin_name+"_conf.js"))return!0;return!1},get_cur_js_url:function(t){void 0===t&&(t=this.js_self_name);var e="",r="";try{e=document.currentScript.src}catch(t){this.local_msg("(api- get_cur_js_url) get exception:"+t.message),r=t.fileName||t.stack||t.sourceURL||t.stacktrace||""}try{if(""!=r&&(e=/((?:http|https|file):\/\/.*?\/[^:]+)(?::\d+)?:\d+/.exec(r)[1]),!e||e.indexOf(t)<0){for(var s=document.scripts,i=s.length-1;0<=i;i--)if(0<=s[i].src.indexOf(this.js_self_name))return e=s[i].src;return this.local_msg("(api- get_cur_js_url) - api js url get failed !"),""}}catch(t){this.local_msg("(api- get_cur_js_url-2) get exception:"+t.message)}return e},_report_log:function(t,e){if(0!=this.log_config_id)if("error"==t||"warn"==t||"reqerr"==t||"info"==t||"debug"==t){this.debug&&this.local_msg("report "+t+" log:"+e);try{var r=new Object;r.type=t,r.msg=e,r.time=Date.parse(new Date),this.logs.push(r),this.cur_logs_strlen+=e.length,this.cur_logs_strlen>=this.max_logs_strlen&&(0!=this.last_delay_timer_id&&(clearTimeout(this.last_delay_timer_id),this.last_delay_timer_id=0),this._report_to_server())}catch(t){this.local_msg("(api - _report_log) get exception:"+t.message)}}else this.local_msg("xrkmonitor - report failed, invalid log type(must - error|warn|reqerr|info|debug!");else this.debug&&this.local_msg("log config id not set, use init_log() to set, msg:"+e)},_try_report_to_server:function(){var t=this,e=0,r=0;if(t.debug){var s=(new Date).getTime();if(s>=t.last_show_try_info_time+3e4)for(t.last_show_try_info_time=s,t.local_msg("domain:"+t.init_win_domain+", try send data to server, new request seq:"+t.req_seq),e=0;e<t.plugins.length;e++)t.local_msg("plugin:"+t.plugins[e].config.plugin_name+" monitor window count:"+t.plugins[e].monitor_win_list.length)}for(e=0;e<t.plugins.length;e++)for(r=0;r<t.plugins[e].monitor_win_list.length;r++)if(t.plugins[e].monitor_win_list[r].b_exception){t.local_msg("remove window from plugin:"+t.plugins[e].config.plugin_name+", window id:"+t.plugins[e].monitor_win_list[r].xrk_window_id),t.plugins[e].monitor_win_list[r]=null,t.plugins[e].monitor_win_list.splice(r,1);break}t.report_to_server(),setTimeout(function(){t._try_report_to_server()},t.try_timer_ms)},_report_to_server:function(t){var e,r=this;if(void 0!==t||0!=r.last_req_seq)return 0==r.last_delay_timer_id&&(void 0===t&&(t=100),r.last_delay_timer_id=setTimeout(function(){(r.last_delay_timer_id=0)<r.request_start_time&&r.request_start_time+r.request_timeout_ms<=(new Date).getTime()&&(r.last_req_seq=0,r.local_msg("clear delay and request seq check, response may timeout")),r._report_to_server()},t)),void(r.debug&&(e="set delay report to server, delay:"+t+" ms",e+=", timer id:"+r.last_delay_timer_id,r.local_msg(e)));0!=r.last_delay_timer_id&&(clearTimeout(r.last_delay_timer_id),r.last_delay_timer_id=0);var s,i=!1,_=new Object,n=null;if(0<r.logs.length)_.log_config_id=r.log_config_id,_.logs=r.logs,i=!0,r.debug&&r.local_msg("report log count:"+_.logs.length);else for(var o=0;o<r.plugins.length;o++)if(!(void 0===r.plugins[o].logs||r.plugins[o].logs.length<=0)){n=r.plugins[o],_.log_config_id=n.config.logconfig_id,_.logs=n.logs,i=!0,r.debug&&r.local_msg("report plugin:"+n.config.plugin_name+" log count:"+n.logs.length);break}0<r.attrs.length&&(_.attrs=r.attrs,i=!0,r.debug&&r.local_msg("report attr count:"+_.attrs.length)),0<r.strattrs.length&&(_.strattrs=r.strattrs,i=!0,r.debug&&r.local_msg("report strattr count:"+_.strattrs.length)),0!=r.master_user_id&&(_.master_user_id=r.master_user_id),""!=r.access_key&&(_.access_key=r.access_key),r.cur_strattrs_strlen=0,r.cur_logs_strlen=0,i&&("object"==typeof JSON&&JSON.stringify?(s=JSON.stringify(_),r._to_server(s)&&(r.logs=new Array,r.attrs=new Array,r.strattrs=new Array,null!=n&&(n.logs=new Array,n.cur_logs_strlen=0))):r.local_msg("xrkmonitor - report failed, not support JSON.stringify !"))},_inner_xrk_report_attr:function(t,e,r){if(void 0===e||"number"!=typeof r||r<=0)this.debug&&this.local_msg("invalid paramter, on attr report !");else{this.debug&&this.local_msg(t+" attr:"+e+", value:"+r);for(var s=0,s=0;s<this.attrs.length;s++)if(this.attrs[s].id==e)return void("set"==t?this.attrs[s].number=r:this.attrs[s].number+=r);var i=new Object;i.id=e,i.number=r,this.attrs.push(i),this.attrs.length>=this.max_attrs_per_req&&(0!=this.last_delay_timer_id&&clearTimeout(this.last_delay_timer_id),this._report_to_server())}},_inner_xrk_report_strattr:function(t,e,r,s){if(void 0===e||"string"!=typeof r||"number"!=typeof s||s<=0)this.debug&&this.local_msg("invalid paramter, on str attr report !");else{this.debug&&this.local_msg(t+" strattr:"+e+", string:"+r+", value:"+s);for(var i=0,i=0;i<this.strattrs.length;i++)if(this.strattrs[i].id==e){for(var _=0;_<this.strattrs[i].strings.length;_++)if(this.strattrs[i].strings[_].string==r)return void("set"==t?this.strattrs[i].strings[_].number=s:this.strattrs[i].strings[_].number+=s);var n=new Object;return 50<r.length?n.string=r.substring(0,50):n.string=r,n.number=s,this.strattrs[i].strings.push(n),this.cur_strattrs_strlen+=n.string.length,void(this.cur_strattrs_strlen>=this.max_strattrs_strlen&&(0!=this.last_delay_timer_id&&clearTimeout(this.last_delay_timer_id),this._report_to_server()))}var o=new Object;o.id=e,o.strings=new Array;n=new Object;50<r.length?n.string=r.substring(0,50):n.string=r,n.number=s,o.strings.push(n),this.strattrs.push(o),this.cur_strattrs_strlen+=n.string.length,this.cur_strattrs_strlen>=this.max_strattrs_strlen&&(0!=this.last_delay_timer_id&&clearTimeout(this.last_delay_timer_id),this._report_to_server())}},_on_response:function(t){var e,r,s=(new Date).getTime();this.last_api_delay=s-this.request_start_time,this.last_api_delay>this.max_api_delay&&(this.max_api_delay=this.last_api_delay),"object"==typeof JSON&&JSON.parse&&(e=JSON.parse(t),this.local_out_ip=e.client_ip,e.cgi_run_time>this.max_api_run&&(this.max_api_run=e.cgi_run_time),this.debug&&this.local_msg("last delay:"+this.last_api_delay+", max delay:"+this.max_api_delay+", cgi run:"+e.cgi_run_time+", ip:"+this.local_out_ip+", end:"+s+", start:"+this.request_start_time)),this.debug&&(r="response:"+t+", last request seq:"+this.last_req_seq,this.local_msg(r)),this.last_req_seq=0,"function"==typeof this.on_xrk_response&&this.on_xrk_response()},_to_server:function(t){var e,r=this;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){return r.local_msg("xrkmonitor - report failed, not support xmHttp request !"),!1}}}if(r.request_start_time=(new Date).getTime(),0==r.freq_send_start_time||r.request_start_time>r.freq_send_start_time+r.freq_check_time)r.freq_send_start_time=r.request_start_time,r.freq_request_times=1;else{if(r.request_start_time<r.freq_send_start_time+r.freq_check_time&&r.freq_request_times>=r.freq_check_limit_times)return r.last_delay_timer_id=setTimeout(function(){r.self_xrk.last_delay_timer_id=0,r.self_xrk._report_to_server()},500),!1;r.freq_request_times++}r.last_req_seq=r.req_seq,r.req_seq++;var s="action=http_report_data&";s+="req_seq="+r.last_req_seq,s+="&data="+t,r.debug&&r.local_msg("send request to server data length:"+s.length+", req seq:"+r.last_req_seq);try{e.open("POST",r.report_url,!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),e.send(s),e.onreadystatechange=function(){4==e.readyState&&200==e.status&&("string"==typeof e.responseText?r._on_response(e.responseText):r._on_response('{ "client_ip":"error!", "cgi_run_time":0}'))}}catch(t){r.local_msg("(api - _to_server) get exception:"+t.message)}return!0},_init:function(){var e=this;try{if("string"==typeof window.document.domain&&(e.init_win_domain=window.document.domain),e.api_js_url=e.get_cur_js_url(),""==e.api_js_url)return void e.local_msg("get :"+e.js_self_name+" url path failed !");e.debug&&e.local_msg("get js:"+e.js_self_name+", url:"+e.api_js_url),e.debug&&e.local_msg("domain:"+e.init_win_domain+", report url:"+e.report_url),e.req_seq++,"undefined"!=typeof JSON&&JSON.stringify?(e._add_plugins(),setTimeout(function(){e._try_report_to_server()},e.try_timer_ms)):e.load_script(e.api_js_url.replace(e.js_self_name,e.json2_js_name),function(){"undefined"!=typeof JSON&&JSON.stringify?(e.local_msg("load json2:"+e.json2_js_name+" ok"),e._add_plugins(),setTimeout(function(){e._try_report_to_server()},e.try_timer_ms)):e.local_msg("load json2:"+e.json2_js_name+" failed !")})}catch(t){e.local_msg("(api-init) get exception:"+t.message)}},_init_more:function(t){this.debug=t,this.load_more++,this._init()},plugins_add_monitor:function(){for(var t=0;t<this.plugins.length;t++){var e=this.plugins[t].create();e.monitor_window(this.plugins[t],window),this.plugins[t].monitor_win_list.push(e)}},_init_start:function(t){this.debug=t,this._init(),this.local_msg("api first load - domain:"+this.init_win_domain)},_add_plugins:function(){for(var t=0;t<this.plugins_ary.length;t++)""!=this.plugins_ary[t]&&this._load_plugin(this.plugins_ary[t])},report_url:"",json2_js_name:"",js_self_name:"",log_config_id:0,master_user_id:0,access_key:"",on_xrk_response:null,debug:0,try_timer_ms:1200,last_show_try_info_time:0,last_delay_timer_id:0,last_req_seq:0,req_seq:0,max_attrs_per_req:120,max_strattrs_strlen:1e3,cur_strattrs_strlen:0,max_logs_strlen:900,cur_logs_strlen:0,request_start_time:0,max_api_delay:0,last_api_delay:0,max_api_run:0,local_out_ip:"",freq_send_start_time:0,freq_request_times:0,api_init_time:0,api_js_url:"",load_more:0,init_win_domain:"",set_report_url:0,freq_check_time:1500,freq_check_limit_times:3,request_timeout_ms:8e3,plugins_ary:new Array,plugins:new Array,logs:new Array,attrs:new Array,strattrs:new Array};return xrk}void 0===window.self_xrk&&Xrkmonitor(!1);